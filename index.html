<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Collisions</title>
	<link rel="stylesheet" type="text/css" href="main.css">
	<script src="/socket.io/socket.io.js"></script>
</head>
<body>
	<div class="startMenu" id="startMenu">
		<div class="startMenuContent">
			<input id="nameInput" type="text" name="name" placeholder="Enter your name here">
			<button id="startButton"> Play </button>
			<p> Grow your black hole, don't get sucked into others. </p>
		</div>
	</div>

	<div id="chatBox">
		<div id="chatFeed"></div>
		<input id="chatInput" placeholder="Press enter to type, escape to close.">
	</div>
	
	<div id="leaderBoard">
		<ol id="leaderList">
			<li></li>
			<li></li>
			<li></li>
			<li></li>
			<li></li>
		</ol>
	</div>

	<canvas></canvas>
	<script src="/canvas.js"></script>
</body>
</html>
<script>
	let btn = document.getElementById('startButton');
	let chatBox = document.getElementById('chatBox');
	let chatFeed = document.getElementById('chatFeed');
	let chatInput = document.getElementById('chatInput');
	let nameInput = document.getElementById('nameInput');
	let startMenu = document.getElementById('startMenu');
	let inSession = false;

	btn.onclick = startGame; 
	function startGame() {
		nameInput.blur();
		startMenu.style.display = 'none';
		chatBox.style.display = 'block';
		inSession = true;
		socket.emit('start', nameInput.value);
	}

	// Chat handling
	addEventListener('keydown', (event) => {
		if (event.key == 'Enter') {
			if (document.activeElement === chatInput)
				submitMsg();
			else if (document.activeElement === nameInput)
				startGame();
			else if (inSession) {
				chatBox.style.display = 'block';
				chatInput.focus();
			}
			else 
				nameInput.focus();
		}
		if (event.key == 'Escape') {
			document.activeElement.blur();
			chatBox.style.display = 'none';
		}
	});

	// Submit new message
	function submitMsg() {
		socket.emit('message', chatInput.value);
		chatInput.value = "";
	}

	// Post new received message
	socket.on('message', (name, msg) => {
		var x = document.createElement("P");
		var t = document.createTextNode(name + ': ' + msg);
		x.appendChild(t);
		chatFeed.appendChild(x);
		chatFeed.scrollTo(0, chatFeed.scrollHeight);
	});

	// Leaderboard handling
	socket.on('update', (particleList) => {
		// Find all hazards, they are what determine score
		hazards = particleList.filter((element) => {
			return (element.type == 'Hazard');
		});

		// Sort them by biggest to smallest mass
		hazards.sort((a,b) => {
			return (a.mass > b.mass) ? -1 : ((b.mass > a.mass) ? 1 : 0);
		});
		
		// Fill leaderboard
		items = document.getElementById('leaderList').children;
		for (let i = 0; i < items.length; i++) {
			if(i < hazards.length)
				items[i].innerHTML = hazards[i].name + ' - ' + hazards[i].mass;	
			else items[i].innerHTML = '';
		}
	});
	
	
</script>
